#!/bin/bash
base_directory="${HOME}/projects/machines/"
name=$1
new_image=$2
. ${base_directory}/lib
if [[ -z ${name} ]]; then echo "Name not set"; exit 1; fi
if [[ ! -f ~/machines/${name}.txt ]]; then echo "VM config not found"; exit 1; fi
if [[ ! -z ${new_image} ]]; then
	echo "installed_image=${new_image}" > ${base_directory}/configs/${name}.txt
fi

vm_disk=$(virsh domblklist $name | grep -E "vda" | awk '{print $2}')
source ${base_directory}/configs/${name}.txt

if [[ -z ${vm_disk} ]]; then echo "VM disk not found"; exit 1; fi
if [[ -z ${installed_image} ]]; then echo "Installed image not set"; exit 1; fi

apply_image "${installed_image}" "${vm_disk}"
sudo virt-customize -q --hostname ${name} -a "${vm_disk}"

if [[ $? -eq 0 ]]; then
	echo "install successful, starting vm ${name}"
	virsh reset "${name}" >/dev/null 2>&1 || virt start ${name} >/dev/null 2>&1
	wait_online "${name}"
	write_ssh_key "${name}" "${ssh_key}"
else
	echo "error"
fi
