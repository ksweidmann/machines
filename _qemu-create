#!/bin/bash
trap ctrl_c INT
base_directory="${HOME}/projects/machines/"
ssh_key=$(cat ${base_directory}/id_rsa.pub)
volume_group="vg00"
. ${base_directory}/lib
create_check_input $1 $2 

sudo lvcreate -q --yes -W y -n ${name}.fs -L10G ${volume_group}
apply_image "${source_path}" "/dev/${volume_group}/${name}.fs"
sudo virt-customize --hostname ${name} -a "/dev/${volume_group}/${name}.fs"
virt-install -n ${name} \
	--memory 1024 \
	--vcpus $(nproc) \
	--cpu host \
	--import \
	--network bridge=br1,model=virtio-net-pci \
	--disk /dev/${volume_group}/${name}.fs,cache=none,bus=virtio,discard=ignore \
	--graphics vnc,listen=0.0.0.0,keymap=en_us \
	--noautoconsole \
	-v \
	--virt-type kvm \
	--console pty,target_type=virtio \
	--serial pty \
	--rng /dev/urandom \
	--video virtio \
	--accelerate \
	--iothreads 4 \
	--os-variant none \
	--channel unix,mode=bind,path=/var/lib/libvirt/qemu/${name}.agent,target_type=virtio,name=org.qemu.guest_agent.0

wait_online "${name}"
write_ssh_key "${name}" "${ssh_key}"
write_config "${name}"